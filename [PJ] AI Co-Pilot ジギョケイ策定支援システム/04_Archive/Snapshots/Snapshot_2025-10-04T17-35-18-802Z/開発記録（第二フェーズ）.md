# 開発記録（第二フェーズ）：本番環境移行に向けた課題解決

## 1. 発見された問題

フロントエンドとバックエンドの連携に、以下の2つの致命的な不整合が存在することが判明した。

1.  **APIエンドポイントの不一致:**
    * フロントエンド (`gemini-api.js`) は `/api/generate` にリクエストを送信している。
    * バックエンド (`main.py`) は `/` でリクエストを待ち受けている。
2.  **思考エンジン（main_engine.py）のインターフェース不一致:**
    * バックエンド (`main.py`) は `analyze_risks_from_conversation` という**関数**を想定している。
    * `main_engine.py` は、単体で実行される**スクリプト**であり、関数として呼び出せる構造になっていない。

## 2. 問題に気づいた経緯

ユーザーからの「本番環境での稼働テスト」という提案を受け、デプロイを前提にプロジェクト全体のソースコードをレビューした。

1.  `default_api.list_files(path=".")` を実行し、プロジェクトの全体像を把握。
2.  `web/gemini-api.js` を読み込み、フロントエンドが `/api/generate` を呼び出していることを確認。
3.  `main.py` を読み込み、FastAPIが `/` でリクエストを待ち受けていること、そして `main_engine.py` を**関数として**呼び出そうとしていることを発見し、上記の2つの不整合に気づいた。

## 3. 問題の根本原因

このプロジェクトは、元々 `main_engine.py` という思考エンジン部分が単体のスクリプトとして開発され、後からそれをWebアプリケーションとして公開するために `main.py` と `web/` ディレクトリが追加されたと推測される。

その際、既存の `main_engine.py` をWeb API（関数）として呼び出すためのリファクタリング（再設計）と、フロントエンドとバックエンド間のAPI仕様のすり合わせが、十分に行われていなかったことが根本的な原因である。

## 4. 解決策

以下のステップでコードを修正し、フロントエンドとバックエンドを正しく連携させる。

1.  **`main_engine.py`の関数化:**
    * 現在のスクリプトとしての処理を `analyze_risks_from_conversation` という名前の関数内に移動させ、引数として会話ログの文字列を受け取り、結果のJSONを返すように構造を変更する。

2.  **`main.py`の修正:**
    * FastAPIのエンドポイントを `@app.post("/")` から `@app.post("/api/generate")` に変更する。
    * リクエストのボディ構造をフロントエンドが送信する形式に合わせる。